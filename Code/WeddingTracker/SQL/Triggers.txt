/* ---------------------------------------------------------------------------------------
	TRIGGERS 
 --------------------------------------------------------------------------------------- */

DELIMITER /

/* On insert into TIME_CHUNK, set TIMELINE(TOTALTIME) */
CREATE OR REPLACE TRIGGER TIME_CHUNK_TRIGGER
BEFORE INSERT ON TIME_CHUNK
FOR EACH ROW
	DECLARE
		v_oldTime TIME;
		v_oldId   INT;
	BEGIN
		/* update the current timelines total time */
		SELECT TIMELINE.TOTALTIME, TIMELINE.ID INTO v_oldTime, v_oldId
		FROM TIMELINE
		WHERE TIMELINE.ID = :NEW.TIMELINEID;

		/* if old time null but valid id, use this time */
		IF v_oldId NOT NULL AND v_oldTime IS NULL
		THEN
			UPDATE TIMELINE
			SET TIMELINE.TOTALTIME = :NEW.DURATION
			WHERE TIMELINE.ID = :NEW.TIMELINEID;
		ELSIF v_oldId NOT NULL
		THEN
			UPDATE TIMELINE
			SET TIMELINE.TOTALTIME = v_oldTime + :NEW.DURATION;
		END IF;
	END;
 /
DELIMETER ;



DROP TRIGGER IF EXISTS test_trig;
commit;

DELIMETER |

/* On insert into TIME_CHUNK, set TIMELINE(TOTALTIME) + NEW.duration */
CREATE TRIGGER test_trig_insert
BEFORE INSERT ON TIME_CHUNK
FOR EACH ROW
	BEGIN
	DECLARE _oldTime TIME;
		
		SELECT TIMELINE.TOTALTIME
		INTO _oldTime
		FROM TIMELINE
		WHERE TIMELINE.ID = NEW.TIMELINEID;

      		UPDATE timeline 
		SET totaltime = NEW.duration + _oldTime
		WHERE timeline.ID = NEW.TIMELINEID;
        END;
 |
DELIMETER ;



DELIMETER |

/* On update into TIME_CHUNK, set TIMELINE(TOTALTIME) + NEW.duration - OLD.duration */
CREATE TRIGGER test_trig_update
BEFORE UPDATE ON TIME_CHUNK
FOR EACH ROW
	BEGIN
	DECLARE _oldTime TIME;
		
		SELECT TIMELINE.TOTALTIME
		INTO _oldTime
		FROM TIMELINE
		WHERE TIMELINE.ID = NEW.TIMELINEID;

      		UPDATE timeline 
		SET totaltime = NEW.duration + _oldTime - OLD.duration
		WHERE timeline.ID = NEW.TIMELINEID;
        END;
 |
DELIMETER ;


DELIMETER |

/* On delete into TIME_CHUNK, set TIMELINE(TOTALTIME) - OLD.duration */
CREATE TRIGGER test_trig_delete
BEFORE DELETE ON TIME_CHUNK
FOR EACH ROW
	BEGIN
	DECLARE _oldTime TIME;
		
		SELECT TIMELINE.TOTALTIME
		INTO _oldTime
		FROM TIMELINE
		WHERE TIMELINE.ID = OLD.TIMELINEID;

      		UPDATE timeline 
		SET totaltime = _oldTime - OLD.duration
		WHERE timeline.ID = OLD.TIMELINEID;
        END;
 |
DELIMETER ;

SELECT * FROM TIMELINE;

INSERT INTO timeline VALUES (DEFAULT,'N','12:10:00',DEFAULT);
SELECT * FROM TIMELINE;

INSERT INTO time_chunk VALUES (DEFAULT,3,'12:10:00','00:15:00');
SELECT * FROM TIMELINE;

INSERT INTO time_chunk VALUES (DEFAULT,3,'12:40:00','00:10:00');
SELECT * FROM TIMELINE;

UPDATE time_chunk
SET DURATION = '0:0:0'
WHERE ID = 4;
SELECT * FROM TIMELINE;

DELETE FROM time_chunk
WHERE ID = 3;
SELECT * FROM TIMELINE;



 COMMIT;