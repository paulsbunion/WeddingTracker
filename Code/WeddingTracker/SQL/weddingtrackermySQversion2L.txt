/*  ---------------------------------------------------------------------------------------
	drop potential conflicting indexes and tables
 --------------------------------------------------------------------------------------- */


DROP	TABLE	IF EXISTS	PERSISTENT_LOGINS;
DROP	TABLE	IF EXISTS	USER_ROLES;
DROP	TABLE	IF EXISTS	USERS;
DROP	TABLE	IF EXISTS	PHOTOGRAPHERLOCATIONS;
DROP	TABLE	IF EXISTS	TIMECHUNKPHOTOGRAPHER;
DROP	TABLE	IF EXISTS	TIME_cHUNK;
DROP	TABLE	IF EXISTS	TIMELINE;
DROP	TABLE	IF EXISTS	ASSIGNED_STAFF;
DROP	TABLE	IF EXISTS	EVENTLOCATIONS;
DROP	TABLE	IF EXISTS	EVENT_CLIENTS;
DROP	TABLE	IF EXISTS	LOCATION;
DROP	TABLE	IF EXISTS	EVENT_PHOTOGRAPHERS;
DROP	TABLE	IF EXISTS	EVENT;
DROP	TABLE	IF EXISTS	EVENTTYPE;
DROP	TABLE	IF EXISTS	CLIENT;
DROP	TABLE	IF EXISTS	PHOTOGRAPHER;

DROP 	VIEW	IF EXISTS	EVENTPHOTOGRAPHERS;

/* ---------------------------------------------------------------------------------------
	create the database tables
 --------------------------------------------------------------------------------------- */


/* ---------------------------------------------------------------------------------------
	Security tables
 --------------------------------------------------------------------------------------- */
CREATE TABLE USERS (
	USERNAME 		VARCHAR(45)	NOT NULL,
	PASSWORD 		VARCHAR(100) 	NOT NULL,
	ENABLED 		TINYINT 	NOT NULL 		DEFAULT 1,
	EMAIL			VARCHAR(64)	NOT NULL,
	
	PRIMARY KEY (USERNAME)
);

CREATE TABLE USER_ROLES (
	USER_ROLE_ID 		INT 		NOT NULL		AUTO_INCREMENT,
	USERNAME		VARCHAR(45)	NOT NULL,
	ROLE			VARCHAR(45)	NOT NULL,
	
	PRIMARY KEY (USER_ROLE_ID),
	UNIQUE KEY UNI_USERNAME_ROLE (ROLE, USERNAME),
	FOREIGN KEY FK_USERNAME_IDX (USERNAME) REFERENCES USERS (USERNAME)
);

CREATE TABLE PERSISTENT_LOGINS (
	USERNAME 		VARCHAR(64)	NOT NULL,
	SERIES			VARCHAR(64)	NOT NULL,
	TOKEN			VARCHAR(64)	NOT NULL,
	LAST_USED		TIMESTAMP	NOT NULL,
	
	PRIMARY KEY (SERIES)
);

/* ---------------------------------------------------------------------------------------
	other tables
 --------------------------------------------------------------------------------------- */


CREATE TABLE PHOTOGRAPHER (
	STAFFID			INT		NOT NULL		AUTO_INCREMENT,
	FIRSTNAME		VARCHAR(20)	NOT NULL,
	LASTNAME		VARCHAR(25)	NOT NULL,
	
	PRIMARY KEY (STAFFID)
);

CREATE TABLE LOCATION (
	LOCATIONID		INT		NOT NULL		AUTO_INCREMENT,
	CITY			VARCHAR(30)	NOT NULL,
	STATE			CHAR(2)		NOT NULL		DEFAULT 'OH',
	ZIP			CHAR(5)		NOT NULL,
	STREET			VARCHAR(30)	NOT NULL,
	DESCRIPTION		VARCHAR(100)	NOT NULL		DEFAULT 'N/A',

	PRIMARY KEY (LOCATIONID)
);

CREATE TABLE EVENTTYPE (
	EVENTTYPEID		INT		NOT NULL		AUTO_INCREMENT,
	EVENTTYPE		VARCHAR(100)	NOT NULL		DEFAULT 'EVENT',
	BASECOST		VARCHAR(8)	DEFAULT 'N/A'		NOT NULL,

	PRIMARY KEY (EVENTTYPEID)
);

CREATE TABLE EVENT (
	EVENTID			INT		NOT NULL		AUTO_INCREMENT,
	EVENTNAME		VARCHAR(100)	NOT NULL		DEFAULT 'NAMELESS EVENT',
	EVENTTYPEID		INT		NOT NULL,
	EVENTDATE		DATE		NOT NULL,
	STARTTIME		TIME		NOT NULL,
	DURATION		TIME		DEFAULT '0:00:00'	NOT NULL,
	EXTRACOST		VARCHAR(8)	DEFAULT '$0.00'		NOT NULL,		
	NOTES			TEXT,

	
	PRIMARY KEY (EVENTID),
	FOREIGN KEY (EVENTTYPEID) REFERENCES EVENTTYPE(EVENTTYPEID) ON UPDATE CASCADE ON DELETE CASCADE,
	CONSTRAINT CHK_MUL_CLI CHECK (MULTICLIENT = 'Y' OR MULTICLIENT = 'N')
);

CREATE TABLE EVENT_PHOTOGRAPHERS (
	EVENTID			INT		NOT NULL,
	STAFFID			INT		NOT NULL,

	PRIMARY KEY (EVENTID, STAFFID),
	FOREIGN KEY (EVENTID) REFERENCES EVENT(EVENTID) ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (STAFFID) REFERENCES PHOTOGRAPHER(STAFFID) ON UPDATE CASCADE ON DELETE CASCADE
);
CREATE TABLE EVENTLOCATIONS (
	EVENTID			INT		NOT NULL,
	LOCATIONID		INT		NOT NULL,

	PRIMARY KEY (EVENTID, LOCATIONID),
	FOREIGN KEY (EVENTID) REFERENCES EVENT(EVENTID),
	FOREIGN KEY (LOCATIONID) REFERENCES LOCATION(LOCATIONID)
);

CREATE TABLE CLIENT (
	CLIENTID		INT		NOT NULL		AUTO_INCREMENT,
	FIRSTNAME		VARCHAR(20)	NOT NULL,
	LASTNAME		VARCHAR(25)	NOT NULL,
	ADDRESS			VARCHAR(100)	NOT NULL,
	PHONENUMBER		CHAR(14)	NOT NULL,
	EMAIL			VARCHAR(50),
	AUTOREMIND		CHAR(1)		NOT NULL		DEFAULT 'N',

	PRIMARY KEY (CLIENTID)
);

CREATE TABLE EVENT_CLIENTS (
	EVENTID			INT		NOT NULL,
	CLIENTID		INT		NOT NULL,
	
	PRIMARY KEY (EVENTID, CLIENTID),
	FOREIGN KEY (EVENTID) REFERENCES EVENT(EVENTID) ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (CLIENTID) REFERENCES CLIENT(CLIENTID) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE TIMELINE (
	EVENTID			INT			NOT NULL,
	STARTTIME		TIME		NOT NULL,
	TOTALTIME		TIME		NOT NULL		DEFAULT '0:0:0',

	PRIMARY KEY (EVENTID),
	FOREIGN KEY (EVENTID) REFERENCES EVENT(EVENTID) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE TIME_CHUNK (
	CHUNKID			INT		NOT NULL,
	EVENTID			INT 		NOT NULL,
	STARTTIME		TIME		NOT NULL,
	POSITION		INT		NOT NULL DEFAULT 0,
	LOCATIONID		INT,
	DURATIONHR		INT		DEFAULT '0',
	DURATIONMIN		INT		DEFAULT '0',
	DESCRIPTION		TEXT,
	CLIENTID		INT,

	PRIMARY KEY (EVENTID, CHUNKID),
	FOREIGN KEY (EVENTID) REFERENCES TIMELINE(EVENTID) ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (LOCATIONID) REFERENCES LOCATION(LOCATIONID) ON UPDATE CASCADE ON DELETE SET NULL,
	FOREIGN KEY (CLIENTID) REFERENCES CLIENT(CLIENTID) ON UPDATE CASCADE ON DELETE SET NULL
);

CREATE TABLE TIMECHUNKPHOTOGRAPHER (
	CHUNKID			INT		NOT NULL,
	EVENTID			INT		NOT NULL,
	STAFFID			INT		NOT NULL,


	PRIMARY KEY (EVENTID, CHUNKID, STAFFID), 
	FOREIGN KEY (EVENTID, CHUNKID) REFERENCES TIME_CHUNK (EVENTID, CHUNKID) ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (STAFFID) REFERENCES PHOTOGRAPHER(STAFFID) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE PHOTOGRAPHERLOCATIONS (
	STAFFID			INT		NOT NULL,
	EVENTID			INT 		NOT NULL,
	CHUNKID			INT		NOT NULL,
	LOCATIONID		INT		NOT NULL,

	PRIMARY KEY (STAFFID, EVENTID, CHUNKID),
	FOREIGN KEY (STAFFID) REFERENCES PHOTOGRAPHER(STAFFID),
	FOREIGN KEY (EVENTID, CHUNKID) REFERENCES TIME_CHUNK(EVENTID, CHUNKID) ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (LOCATIONID) REFERENCES LOCATION(LOCATIONID) ON UPDATE CASCADE ON DELETE CASCADE
);


/* ---------------- Views ------------------- */


CREATE VIEW EVENTPHOTOGRAPHERS AS
SELECT DISTINCT E.EVENTID, E.EVENTNAME, E.EVENTDATE, E.STARTTIME, P.STAFFID, CONCAT_WS(" ", P.FIRSTNAME, P.LASTNAME) AS PHOTOGRAPHER
FROM EVENT E, TIMECHUNKPHOTOGRAPHER TCP, PHOTOGRAPHER P
WHERE E.EVENTID = TCP.EVENTID AND TCP.STAFFID = P.STAFFID;


/* ---------------------------------------------------------------------------------------
	insert users
 --------------------------------------------------------------------------------------- */

/* password = 1234 */
INSERT INTO USERS(USERNAME, PASSWORD, ENABLED, EMAIL)
VALUES ('christy', '$2a$10$dOal6BQburfnk7BoGb4BGO.mWjX2Sfvz3XB.XMplOpp6e.6Gbw7RG', true, 'a@b.c');

/* password = password */
INSERT INTO USERS(USERNAME, PASSWORD, ENABLED, EMAIL)
VALUES ('user', '$2a$10$5YXXBALvZKT67kMoYxp.T.rSsuRXZKParEPaGWTpprBI5cCklFdkW', true, 'a@c.c');

INSERT INTO USER_ROLES (USERNAME, ROLE)
VALUES ('christy', 'ROLE_USER');

INSERT INTO USER_ROLES (USERNAME, ROLE)
VALUES ('christy', 'ROLE_ADMIN');

INSERT INTO USER_ROLES (USERNAME, ROLE)
VALUES ('user', 'ROLE_USER');
